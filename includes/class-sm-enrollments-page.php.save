<?php
// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

class SM_Enrollments_Page {

    /**
     * Create enrollment fees (insurance + books)
     */
    private static function create_enrollment_fees( $enrollment_id, $post_data ) {
        global $wpdb;
        $enrollment_fees_table = $wpdb->prefix . 'sm_enrollment_fees';
        $enrollments_table = $wpdb->prefix . 'sm_enrollments';
        
        $enrollment = $wpdb->get_row( $wpdb->prepare(
            "SELECT student_id, enrollment_date FROM $enrollments_table WHERE id = %d",
            $enrollment_id
        ) );
        
        if ( ! $enrollment ) {
            return;
        }
        
        $insurance_fee = floatval( $post_data['insurance_fee'] ?? 0 );
        $book_fee = floatval( $post_data['book_fee'] ?? 0 );
        $enrollment_date = $enrollment->enrollment_date;
        
        // Check if this is student's first enrollment (for insurance)
        $previous_enrollments = $wpdb->get_var( $wpdb->prepare(
            "SELECT COUNT(*) FROM $enrollments_table WHERE student_id = %d AND id < %d",
            $enrollment->student_id,
            $enrollment_id
        ) );
        
        // Add insurance fee only if first enrollment AND amount > 0
        if ( $previous_enrollments == 0 && $insurance_fee > 0 ) {
            $wpdb->insert( $enrollment_fees_table, [
                'enrollment_id' => $enrollment_id,
                'fee_type' => 'insurance',
                'amount' => $insurance_fee,
                'status' => 'unpaid',
                'due_date' => $enrollment_date,
            ] );
        }
        
        // Add book fee if amount > 0
        if ( $book_fee > 0 ) {
            $wpdb->insert( $enrollment_fees_table, [
                'enrollment_id' => $enrollment_id,
                'fee_type' => 'books',
                'amount' => $book_fee,
                'status' => 'unpaid',
                'due_date' => $enrollment_date,
            ] );
        }
    }

    /**
     * Create payment schedule based on payment plan
     */
    private static function create_payment_schedule( $enrollment_id, $post_data ) {
        global $wpdb;
        $payment_schedules_table = $wpdb->prefix . 'sm_payment_schedules';
        $enrollments_table = $wpdb->prefix . 'sm_enrollments';
        $courses_table = $wpdb->prefix . 'sm_courses';
        
        $enrollment = $wpdb->get_row( $wpdb->prepare(
            "SELECT e.*, c.price_per_month, c.total_months 
             FROM $enrollments_table e
             LEFT JOIN $courses_table c ON e.course_id = c.id
             WHERE e.id = %d",
            $enrollment_id
        ) );
        
        if ( ! $enrollment ) {
            return;
        }
        
        $payment_plan = sanitize_text_field( $post_data['payment_plan'] ?? 'monthly' );
        $price_per_month = floatval( $enrollment->price_per_month );
        $total_months = intval( $enrollment->total_months );
        $start_date = $enrollment->start_date;
        
        $installments = [];
        
        switch ( $payment_plan ) {
            case 'monthly':
                // One payment per month
                for ( $i = 0; $i < $total_months; $i++ ) {
                    $installments[] = [
                        'number' => $i + 1,
                        'amount' => $price_per_month,
                        'due_date' => date( 'Y-m-d', strtotime( "+$i months", strtotime( $start_date ) ) ),
                    ];
                }
                break;
                
            case 'quarterly':
                // Payment every 3 months
                $num_quarters = ceil( $total_months / 3 );
                for ( $i = 0; $i < $num_quarters; $i++ ) {
                    $months_in_quarter = min( 3, $total_months - ( $i * 3 ) );
                    $installments[] = [
                        'number' => $i + 1,
                        'amount' => $price_per_month * $months_in_quarter,
                        'due_date' => date( 'Y-m-d', strtotime( "+" . ( $i * 3 ) . " months", strtotime( $start_date ) ) ),
                    ];
                }
                break;
                
            case 'full':
                // Single payment for entire course
                $installments[] = [
                    'number' => 1,
                    'amount' => $price_per_month * $total_months,
                    'due_date' => $start_date,
                ];
                break;
        }
        
        // Insert installments into database
        foreach ( $installments as $installment ) {
            $wpdb->insert( $payment_schedules_table, [
                'enrollment_id' => $enrollment_id,
                'installment_number' => $installment['number'],
                'expected_amount' => $installment['amount'],
                'due_date' => $installment['due_date'],
                'status' => 'pending',
                'paid_amount' => 0,
            ] );
        }
    }
    /**
     * Render the Enrollments page
     */
    public static function render_enrollments_page() {
        // Security check
        if ( ! current_user_can( 'manage_enrollments' ) ) {
            wp_die( __( 'You do not have sufficient permissions to access this page.', 'CTADZ-school-management' ) );
        }
        
        global $wpdb;
        $table = $wpdb->prefix . 'sm_enrollments';

        // Handle delete action
        if ( isset( $_GET['delete'] ) && check_admin_referer( 'sm_delete_enrollment_' . intval( $_GET['delete'] ) ) ) {
            $deleted = $wpdb->delete( $table, [ 'id' => intval( $_GET['delete'] ) ] );
            if ( $deleted ) {
                echo '<div class="updated notice"><p>' . esc_html__( 'Enrollment deleted successfully.', 'CTADZ-school-management' ) . '</p></div>';
            } else {
                echo '<div class="error notice"><p>' . esc_html__( 'Error deleting enrollment.', 'CTADZ-school-management' ) . '</p></div>';
            }
        }

        // Handle form submission
        if ( isset( $_POST['sm_save_enrollment'] ) && check_admin_referer( 'sm_save_enrollment_action', 'sm_save_enrollment_nonce' ) ) {
            $validation_result = self::validate_enrollment_data( $_POST );
    
            if ( $validation_result['success'] ) {
                $data = $validation_result['data'];
                $enrollment_id = intval( $_POST['enrollment_id'] ?? 0 );
        
                if ( $enrollment_id > 0 ) {
                    // Update existing enrollment
                    $updated = $wpdb->update( $table, $data, [ 'id' => $enrollment_id ] );
                    if ( $updated !== false ) {
                        echo '<div class="updated notice"><p>' . esc_html__( 'Enrollment updated successfully.', 'CTADZ-school-management' ) . '</p></div>';
                        echo '<script>setTimeout(function(){ window.location.href = "?page=school-management-enrollments"; }, 2000);</script>';
                    }
                } else {
                    // Insert new enrollment
                    $inserted = $wpdb->insert( $table, $data );
                    if ( $inserted ) {
                        $new_enrollment_id = $wpdb->insert_id;
                
                        // Create enrollment fees and payment schedules
                        self::create_enrollment_fees( $new_enrollment_id, $_POST );
                        self::create_payment_schedule( $new_enrollment_id, $_POST );
                
                        echo '<div class="updated notice"><p>' . esc_html__( 'Enrollment added successfully with payment schedule generated.', 'CTADZ-school-management' ) . '</p></div>';
                        echo '<script>setTimeout(function(){ window.location.href = "?page=school-management-enrollments"; }, 2000);</script>';
                    }
                }
            } else {
                echo '<div class="error notice"><p><strong>' . esc_html__( 'Please correct the following errors:', 'CTADZ-school-management' ) . '</strong></p>';
                echo '<ul style="margin-left: 20px;">';
                foreach ( $validation_result['errors'] as $error ) {
                    echo '<li>' . esc_html( $error ) . '</li>';
                }
                echo '</ul></div>';
            }
        }
        // Determine view
        $action = $_GET['action'] ?? 'list';
        $enrollment = null;

        if ( $action === 'edit' && isset( $_GET['enrollment_id'] ) ) {
            $enrollment = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM $table WHERE id = %d", intval( $_GET['enrollment_id'] ) ) );
        }

        ?>
        <div class="wrap">
            <h1><?php esc_html_e( 'Manage Enrollments', 'CTADZ-school-management' ); ?></h1>

            <?php
            switch ( $action ) {
                case 'add':
                    self::render_enrollment_form( null );
                    break;
                case 'edit':
                    self::render_enrollment_form( $enrollment );
                    break;
                default:
                    self::render_enrollments_list();
                    break;
            }
            ?>
        </div>
        <?php
    }

    /**
     * Validate enrollment data
     */
    private static function validate_enrollment_data( $post_data ) {
        global $wpdb;
        $enrollments_table = $wpdb->prefix . 'sm_enrollments';
        $students_table = $wpdb->prefix . 'sm_students';
        $courses_table = $wpdb->prefix . 'sm_courses';
        $levels_table = $wpdb->prefix . 'sm_levels';
        
        $errors = [];
        
        $student_id = intval( $post_data['student_id'] ?? 0 );
        $course_id = intval( $post_data['course_id'] ?? 0 );
        $enrollment_date = sanitize_text_field( trim( $post_data['enrollment_date'] ?? '' ) );
        $start_date = sanitize_text_field( trim( $post_data['start_date'] ?? '' ) );
        $end_date = sanitize_text_field( trim( $post_data['end_date'] ?? '' ) );
        $status = sanitize_text_field( trim( $post_data['status'] ?? 'active' ) );
        $payment_status = sanitize_text_field( trim( $post_data['payment_status'] ?? 'unpaid' ) );
        $notes = sanitize_textarea_field( trim( $post_data['notes'] ?? '' ) );
        $enrollment_id = intval( $post_data['enrollment_id'] ?? 0 );

        // Required field validation
        if ( $student_id <= 0 ) {
            $errors[] = __( 'Please select a student.', 'CTADZ-school-management' );
        }

        if ( $course_id <= 0 ) {
            $errors[] = __( 'Please select a course.', 'CTADZ-school-management' );
        }

        if ( empty( $enrollment_date ) ) {
            $errors[] = __( 'Enrollment date is required.', 'CTADZ-school-management' );
        }

        if ( empty( $start_date ) ) {
            $errors[] = __( 'Start date is required.', 'CTADZ-school-management' );
        }

        // Validate dates
        if ( ! empty( $start_date ) && ! empty( $enrollment_date ) && strtotime( $start_date ) < strtotime( $enrollment_date ) ) {
            $errors[] = __( 'Start date cannot be before enrollment date.', 'CTADZ-school-management' );
        }

        if ( ! empty( $end_date ) && ! empty( $start_date ) && strtotime( $end_date ) < strtotime( $start_date ) ) {
            $errors[] = __( 'End date cannot be before start date.', 'CTADZ-school-management' );
        }

        // Check for duplicate enrollment
        if ( $student_id > 0 && $course_id > 0 ) {
            $duplicate_query = "SELECT id FROM $enrollments_table WHERE student_id = %d AND course_id = %d";
            $params = [ $student_id, $course_id ];
            
            if ( $enrollment_id > 0 ) {
                $duplicate_query .= " AND id != %d";
                $params[] = $enrollment_id;
            }
            
            $duplicate = $wpdb->get_var( $wpdb->prepare( $duplicate_query, $params ) );
            if ( $duplicate ) {
                $errors[] = __( 'This student is already enrolled in this course.', 'CTADZ-school-management' );
            }
        }

        // Check level prerequisite (student level must match or be below course level)
        if ( $student_id > 0 && $course_id > 0 ) {
            $student = $wpdb->get_row( $wpdb->prepare( "SELECT level_id FROM $students_table WHERE id = %d", $student_id ) );
            $course = $wpdb->get_row( $wpdb->prepare( "SELECT level_id FROM $courses_table WHERE id = %d", $course_id ) );
            
            if ( $student && $course ) {
                $student_level_order = $wpdb->get_var( $wpdb->prepare( "SELECT sort_order FROM $levels_table WHERE id = %d", $student->level_id ) );
                $course_level_order = $wpdb->get_var( $wpdb->prepare( "SELECT sort_order FROM $levels_table WHERE id = %d", $course->level_id ) );
                
                if ( $student_level_order > $course_level_order ) {
                    $errors[] = __( 'Student level is too advanced for this course. Students can only enroll in courses at their level or above.', 'CTADZ-school-management' );
                }
            }
        }

        // Check course capacity
        if ( $course_id > 0 && $enrollment_id == 0 ) { // Only check on new enrollments
            $course = $wpdb->get_row( $wpdb->prepare( "SELECT max_students FROM $courses_table WHERE id = %d", $course_id ) );
            
            if ( $course && $course->max_students > 0 ) {
                $current_enrollments = $wpdb->get_var( $wpdb->prepare( 
                    "SELECT COUNT(*) FROM $enrollments_table WHERE course_id = %d AND status IN ('active', 'completed')", 
                    $course_id 
                ) );
                
                if ( $current_enrollments >= $course->max_students ) {
                    $errors[] = sprintf( __( 'This course is full. Maximum capacity: %d students.', 'CTADZ-school-management' ), $course->max_students );
                }
            }
        }

        // Validate status
        $valid_statuses = [ 'active', 'completed', 'dropped', 'suspended' ];
        if ( ! in_array( $status, $valid_statuses ) ) {
            $errors[] = __( 'Invalid enrollment status.', 'CTADZ-school-management' );
        }

        // Validate payment status
        $valid_payment_statuses = [ 'paid', 'unpaid', 'partial', 'overdue' ];
        if ( ! in_array( $payment_status, $valid_payment_statuses ) ) {
            $errors[] = __( 'Invalid payment status.', 'CTADZ-school-management' );
        }

        // Validate payment plan against course payment model (only for new enrollments)
        if ( $enrollment_id == 0 && $course_id > 0 ) {
            $payment_plan = sanitize_text_field( $post_data['payment_plan'] ?? 'monthly' );
            $validation_result = sm_validate_enrollment_payment_plan( $course_id, $payment_plan );
            
            if ( is_wp_error( $validation_result ) ) {
                $errors[] = $validation_result->get_error_message();
            }
        }

        if ( empty( $errors ) ) {
            return [
                'success' => true,
                'data' => [
                    'student_id' => $student_id,
                    'course_id' => $course_id,
                    'enrollment_date' => $enrollment_date,
                    'start_date' => $start_date,
                    'end_date' => $end_date ?: null,
                    'status' => $status,
                    'payment_status' => $payment_status,
                    'payment_plan' => sanitize_text_field( $post_data['payment_plan'] ?? 'monthly' ),  // ADD THIS LINE
                    'notes' => $notes,
                ]
            ];
        }

        return [ 'success' => false, 'errors' => $errors ];
    }

    /**
     * Render enrollments list
     */
    private static function render_enrollments_list() {
        global $wpdb;
        $enrollments_table = $wpdb->prefix . 'sm_enrollments';
        $students_table = $wpdb->prefix . 'sm_students';
        $courses_table = $wpdb->prefix . 'sm_courses';

        // Pagination
        $per_page = 20;
        $current_page = isset( $_GET['paged'] ) ? absint( $_GET['paged'] ) : 1;
        $offset = ( $current_page - 1 ) * $per_page;

        $total_enrollments = $wpdb->get_var( "SELECT COUNT(*) FROM $enrollments_table" );
        $total_pages = ceil( $total_enrollments / $per_page );

        // Get enrollments with student and course names
        $enrollments = $wpdb->get_results( $wpdb->prepare( 
            "SELECT e.*, s.name as student_name, c.name as course_name 
             FROM $enrollments_table e 
             LEFT JOIN $students_table s ON e.student_id = s.id 
             LEFT JOIN $courses_table c ON e.course_id = c.id 
             ORDER BY e.enrollment_date DESC 
             LIMIT %d OFFSET %d", 
            $per_page, 
            $offset 
        ) );

        ?>
        <div class="sm-header-actions" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h2 style="margin: 0;"><?php esc_html_e( 'Enrollments List', 'CTADZ-school-management' ); ?></h2>
                <p class="description"><?php printf( esc_html__( 'Total: %d enrollments', 'CTADZ-school-management' ), $total_enrollments ); ?></p>
            </div>
            <div>
                <a href="?page=school-management-enrollments&action=add" class="button button-primary">
                    <span class="dashicons dashicons-plus-alt" style="vertical-align: middle;"></span>
                    <?php esc_html_e( 'New Enrollment', 'CTADZ-school-management' ); ?>
                </a>
            </div>
        </div>

        <?php if ( $enrollments ) : ?>
            <table class="wp-list-table widefat fixed striped">
                <thead>
                    <tr>
                        <th><?php esc_html_e( 'Student', 'CTADZ-school-management' ); ?></th>
                        <th><?php esc_html_e( 'Course', 'CTADZ-school-management' ); ?></th>
                        <th><?php esc_html_e( 'Enrolled', 'CTADZ-school-management' ); ?></th>
                        <th><?php esc_html_e( 'Start Date', 'CTADZ-school-management' ); ?></th>
                        <th><?php esc_html_e( 'Status', 'CTADZ-school-management' ); ?></th>
                        <th><?php esc_html_e( 'Payment', 'CTADZ-school-management' ); ?></th>
                        <th style="width: 150px;"><?php esc_html_e( 'Actions', 'CTADZ-school-management' ); ?></th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ( $enrollments as $enrollment ) : ?>
                        <tr>
                            <td><strong><?php echo esc_html( $enrollment->student_name ?: '—' ); ?></strong></td>
                            <td><?php echo esc_html( $enrollment->course_name ?: '—' ); ?></td>
                            <td><?php echo esc_html( date( 'M j, Y', strtotime( $enrollment->enrollment_date ) ) ); ?></td>
                            <td><?php echo esc_html( date( 'M j, Y', strtotime( $enrollment->start_date ) ) ); ?></td>
                            <td>
                                <?php
                                $status_colors = [
                                    'active' => '#46b450',
                                    'completed' => '#00a0d2',
                                    'dropped' => '#dc3232',
                                    'suspended' => '#f0ad4e'
                                ];
                                $color = $status_colors[ $enrollment->status ] ?? '#666';
                                $status_labels = [
                                    'active' => __( 'Active', 'CTADZ-school-management' ),
                                    'completed' => __( 'Completed', 'CTADZ-school-management' ),
                                    'dropped' => __( 'Dropped', 'CTADZ-school-management' ),
                                    'suspended' => __( 'Suspended', 'CTADZ-school-management' )
                                ];
                                $label = $status_labels[ $enrollment->status ] ?? $enrollment->status;
                                ?>
                                <span style="color: <?php echo esc_attr( $color ); ?>;">● <?php echo esc_html( $label ); ?></span>
                            </td>
                            <td>
                                <?php
                                $payment_colors = [
                                    'paid' => '#46b450',
                                    'unpaid' => '#dc3232',
                                    'partial' => '#f0ad4e',
                                    'overdue' => '#d63638'
                                ];
                                $p_color = $payment_colors[ $enrollment->payment_status ] ?? '#666';
                                $payment_labels = [
                                    'paid' => __( 'Paid', 'CTADZ-school-management' ),
                                    'unpaid' => __( 'Unpaid', 'CTADZ-school-management' ),
                                    'partial' => __( 'Partial', 'CTADZ-school-management' ),
                                    'overdue' => __( 'Overdue', 'CTADZ-school-management' )
                                ];
                                $p_label = $payment_labels[ $enrollment->payment_status ] ?? $enrollment->payment_status;
                                ?>
                                <span style="color: <?php echo esc_attr( $p_color ); ?>;">● <?php echo esc_html( $p_label ); ?></span>
                            </td>
                            <td>
                                <a href="?page=school-management-enrollments&action=edit&enrollment_id=<?php echo intval( $enrollment->id ); ?>" class="button button-small">
                                    <span class="dashicons dashicons-edit" style="vertical-align: middle;"></span>
                                </a>
                                <?php
                                $delete_url = wp_nonce_url( 
                                    '?page=school-management-enrollments&delete=' . intval( $enrollment->id ), 
                                    'sm_delete_enrollment_' . intval( $enrollment->id ) 
                                );
                                ?>
                                <a href="<?php echo esc_url( $delete_url ); ?>" 
                                   class="button button-small button-link-delete"
                                   onclick="return confirm('<?php echo esc_js( __( 'Are you sure you want to delete this enrollment?', 'CTADZ-school-management' ) ); ?>')">
                                    <span class="dashicons dashicons-trash" style="vertical-align: middle; color: #d63638;"></span>
                                </a>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>

            <?php
            // Pagination
            if ( $total_pages > 1 ) {
                $pagination_args = [
                    'base' => add_query_arg( 'paged', '%#%' ),
                    'format' => '',
                    'prev_text' => __( '« Previous', 'CTADZ-school-management' ),
                    'next_text' => __( 'Next »', 'CTADZ-school-management' ),
                    'total' => $total_pages,
                    'current' => $current_page,
                ];
                echo '<div class="tablenav bottom"><div class="tablenav-pages">';
                echo paginate_links( $pagination_args );
                echo '</div></div>';
            }
            ?>

        <?php else : ?>
            <div class="sm-empty-state" style="text-align: center; padding: 60px 20px; background: #fafafa; border: 1px dashed #ddd; border-radius: 4px;">
                <span class="dashicons dashicons-welcome-learn-more" style="font-size: 48px; color: #ccc; display: block; margin-bottom: 16px;"></span>
                <h3><?php esc_html_e( 'No Enrollments Yet', 'CTADZ-school-management' ); ?></h3>
                <p><?php esc_html_e( 'Start enrolling students in courses.', 'CTADZ-school-management' ); ?></p>
                <a href="?page=school-management-enrollments&action=add" class="button button-primary">
                    <?php esc_html_e( 'Create First Enrollment', 'CTADZ-school-management' ); ?>
                </a>
            </div>
        <?php endif;
    }

    /**
     * Render enrollment form
     */
    private static function render_enrollment_form( $enrollment = null ) {
        global $wpdb;
        $is_edit = ! empty( $enrollment );
        
        // Get students and courses
        $students = $wpdb->get_results( "SELECT id, name, level_id FROM {$wpdb->prefix}sm_students ORDER BY name ASC" );
        $courses = $wpdb->get_results( "SELECT c.id, c.name, c.level_id, c.max_students, l.name as level_name 
                                        FROM {$wpdb->prefix}sm_courses c 
                                        LEFT JOIN {$wpdb->prefix}sm_levels l ON c.level_id = l.id 
                                        WHERE c.is_active = 1 
                                        ORDER BY c.name ASC" );
        
        $form_data = [];
        if ( isset( $_POST['sm_save_enrollment'] ) ) {
            $form_data = [
                'student_id' => intval( $_POST['student_id'] ?? 0 ),
                'course_id' => intval( $_POST['course_id'] ?? 0 ),
                'enrollment_date' => sanitize_text_field( $_POST['enrollment_date'] ?? '' ),
                'start_date' => sanitize_text_field( $_POST['start_date'] ?? '' ),
                'end_date' => sanitize_text_field( $_POST['end_date'] ?? '' ),
                'status' => sanitize_text_field( $_POST['status'] ?? 'active' ),
                'payment_status' => sanitize_text_field( $_POST['payment_status'] ?? 'unpaid' ),
                'notes' => sanitize_textarea_field( $_POST['notes'] ?? '' ),
            ];
        } elseif ( $enrollment ) {
            $form_data = [
                'student_id' => $enrollment->student_id,
                'course_id' => $enrollment->course_id,
                'enrollment_date' => $enrollment->enrollment_date,
                'start_date' => $enrollment->start_date,
                'end_date' => $enrollment->end_date,
                'status' => $enrollment->status,
                'payment_status' => $enrollment->payment_status,
                'notes' => $enrollment->notes,
            ];
        }
        
        ?>
        <div class="sm-form-header" style="margin-bottom: 20px;">
            <a href="?page=school-management-enrollments" class="button">
                <span class="dashicons dashicons-arrow-left-alt2" style="vertical-align: middle;"></span>
                <?php esc_html_e( 'Back to Enrollments', 'CTADZ-school-management' ); ?>
            </a>
            <h2 style="display: inline-block; margin-left: 10px;">
                <?php echo $is_edit ? esc_html__( 'Edit Enrollment', 'CTADZ-school-management' ) : esc_html__( 'New Enrollment', 'CTADZ-school-management' ); ?>
            </h2>
        </div>

        <form method="post">
            <?php wp_nonce_field( 'sm_save_enrollment_action', 'sm_save_enrollment_nonce' ); ?>
            <input type="hidden" name="enrollment_id" value="<?php echo esc_attr( $enrollment->id ?? '' ); ?>" />

            <table class="form-table">
                <tr>
                    <th scope="row">
                        <label for="enrollment_student"><?php esc_html_e( 'Student', 'CTADZ-school-management' ); ?> <span style="color: #d63638;">*</span></label>
                    </th>
                    <td>
                        <select id="enrollment_student" name="student_id" required <?php echo $is_edit ? 'disabled' : ''; ?>>
                            <option value=""><?php esc_html_e( 'Select Student', 'CTADZ-school-management' ); ?></option>
                            <?php foreach ( $students as $student ) : ?>
                                <option value="<?php echo intval( $student->id ); ?>" <?php selected( $form_data['student_id'] ?? 0, $student->id ); ?>>
                                    <?php echo esc_html( $student->name ); ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                        <?php if ( $is_edit ) : ?>
                            <input type="hidden" name="student_id" value="<?php echo esc_attr( $form_data['student_id'] ?? '' ); ?>" />
                            <p class="description"><?php esc_html_e( 'Student cannot be changed after enrollment.', 'CTADZ-school-management' ); ?></p>
                        <?php else : ?>
                            <p class="description">
                                <a href="?page=school-management-students&action=add" target="_blank"><?php esc_html_e( 'Add new student', 'CTADZ-school-management' ); ?></a>
                            </p>
                        <?php endif; ?>
                    </td>
                </tr>

                <tr>
                    <th scope="row">
                        <label for="enrollment_course"><?php esc_html_e( 'Course', 'CTADZ-school-management' ); ?> <span style="color: #d63638;">*</span></label>
                    </th>
                    <td>
                        <select id="enrollment_course" name="course_id" required <?php echo $is_edit ? 'disabled' : ''; ?>>
                            <option value=""><?php esc_html_e( 'Select Course', 'CTADZ-school-management' ); ?></option>
                            <?php foreach ( $courses as $course ) : 
                                // Get current enrollment count
                                $current_count = $wpdb->get_var( $wpdb->prepare( 
                                    "SELECT COUNT(*) FROM {$wpdb->prefix}sm_enrollments WHERE course_id = %d AND status IN ('active', 'completed')", 
                                    $course->id 
                                ) );
                                $spots_info = '';
                                if ( $course->max_students > 0 ) {
                                    $spots_left = $course->max_students - $current_count;
                                    $spots_info = " ($spots_left spots left)";
                                }
                            ?>
                                <option value="<?php echo intval( $course->id ); ?>" <?php selected( $form_data['course_id'] ?? 0, $course->id ); ?>>
                                    <?php echo esc_html( $course->name . ' - ' . $course->level_name . $spots_info ); ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                        <?php if ( $is_edit ) : ?>
                            <input type="hidden" name="course_id" value="<?php echo esc_attr( $form_data['course_id'] ?? '' ); ?>" />
                            <p class="description"><?php esc_html_e( 'Course cannot be changed after enrollment.', 'CTADZ-school-management' ); ?></p>
                        <?php else : ?>
                            <p class="description">
                                <a href="?page=school-management-courses&action=add" target="_blank"><?php esc_html_e( 'Add new course', 'CTADZ-school-management' ); ?></a>
                            </p>
                        <?php endif; ?>
                    </td>
                </tr>

                <tr>
                    <th scope="row">
                        <label for="enrollment_date"><?php esc_html_e( 'Enrollment Date', 'CTADZ-school-management' ); ?> <span style="color: #d63638;">*</span></label>
                    </th>
                    <td>
                        <input type="date" id="enrollment_date" name="enrollment_date" value="<?php echo esc_attr( $form_data['enrollment_date'] ?? date('Y-m-d') ); ?>" required />
                        <p class="description"><?php esc_html_e( 'Date when the student enrolled in the course.', 'CTADZ-school-management' ); ?></p>
                    </td>
                </tr>

                <tr>
                    <th scope="row">
                        <label for="start_date"><?php esc_html_e( 'Start Date', 'CTADZ-school-management' ); ?> <span style="color: #d63638;">*</span></label>
                    </th>
                    <td>
                        <input type="date" id="start_date" name="start_date" value="<?php echo esc_attr( $form_data['start_date'] ?? '' ); ?>" required />
                        <p class="description"><?php esc_html_e( 'Date when the student begins attending the course.', 'CTADZ-school-management' ); ?></p>
                    </td>
                </tr>

                <tr>
                    <th scope="row">
                        <label for="end_date"><?php esc_html_e( 'End Date', 'CTADZ-school-management' ); ?></label>
                    </th>
                    <td>
                        <input type="date" id="end_date" name="end_date" value="<?php echo esc_attr( $form_data['end_date'] ?? '' ); ?>" />
                        <p class="description"><?php esc_html_e( 'Optional: Date when the student completes or leaves the course.', 'CTADZ-school-management' ); ?></p>
                    </td>
                </tr>

                <?php if ( ! $is_edit ) : // Only show for new enrollments ?>
                <tr>
                    <td colspan="2"><hr style="margin: 20px 0; border: none; border-top: 2px solid #0073aa;"></td>
                </tr>
                <tr>
                    <td colspan="2">
                        <h3 style="margin: 10px 0;"><?php esc_html_e( 'Payment Information', 'CTADZ-school-management' ); ?></h3>
                        <p class="description"><?php esc_html_e( 'Set enrollment fees and payment schedule for this enrollment.', 'CTADZ-school-management' ); ?></p>
                    </td>
                </tr>

                <tr>
                    <th scope="row">
                        <label for="insurance_fee"><?php esc_html_e( 'Insurance Fee', 'CTADZ-school-management' ); ?></label>
                    </th>
                    <td>
                        <input type="number" id="insurance_fee" name="insurance_fee" value="<?php echo esc_attr( $form_data['insurance_fee'] ?? '0' ); ?>" step="0.01" min="0" style="width: 200px;" />
                        <p class="description"><?php esc_html_e( 'One-time insurance fee (only charged for student\'s first enrollment).', 'CTADZ-school-management' ); ?></p>
                    </td>
                </tr>

                <tr>
                    <th scope="row">
                        <label for="book_fee"><?php esc_html_e( 'Book Fee', 'CTADZ-school-management' ); ?></label>
                    </th>
                    <td>
                        <input type="number" id="book_fee" name="book_fee" value="<?php echo esc_attr( $form_data['book_fee'] ?? '0' ); ?>" step="0.01" min="0" style="width: 200px;" />
                        <p class="description"><?php esc_html_e( 'Book and materials fee for this course.', 'CTADZ-school-management' ); ?></p>
                    </td>
                </tr>

                <!-- Course Payment Information Display -->
                <tr id="course_payment_info_row" style="display:none;">
                    <td colspan="2">
                        <div id="course_payment_info" class="sm-course-payment-info">
                            <div class="sm-payment-model-badge"></div>
                            <h4><?php esc_html_e( 'Course Payment Requirements', 'CTADZ-school-management' ); ?></h4>
                            <p class="sm-course-name"></p>
                            <p class="sm-payment-details"></p>
                        </div>
                    </td>
                </tr>

                <tr>
                    <th scope="row">
                        <label for="payment_plan"><?php esc_html_e( 'Payment Plan', 'CTADZ-school-management' ); ?> <span style="color: #d63638;">*</span></label>
                    </th>
                    <td>
                        <select id="payment_plan" name="payment_plan" required>
                            <option value="monthly" <?php selected( $form_data['payment_plan'] ?? 'monthly', 'monthly' ); ?>><?php esc_html_e( 'Monthly Payments', 'CTADZ-school-management' ); ?></option>
                            <option value="quarterly" <?php selected( $form_data['payment_plan'] ?? '', 'quarterly' ); ?>><?php esc_html_e( 'Quarterly Payments (Every 3 months)', 'CTADZ-school-management' ); ?></option>
                            <option value="full" <?php selected( $form_data['payment_plan'] ?? '', 'full' ); ?>><?php esc_html_e( 'Full Payment (One-time)', 'CTADZ-school-management' ); ?></option>
                        </select>
                        <p class="description"><?php esc_html_e( 'Choose how the student will pay for the course.', 'CTADZ-school-management' ); ?></p>
                    </td>
                </tr>
                <tr>
                    <td colspan="2"><hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;"></td>
                </tr>
                <?php endif; ?>
                <tr>
                    <th scope="row">
                        <label for="enrollment_status"><?php esc_html_e( 'Enrollment Status', 'CTADZ-school-management' ); ?> <span style="color: #d63638;">*</span></label>
                    </th>
                    <td>
                        <select id="enrollment_status" name="status" required>
                            <option value="active" <?php selected( $form_data['status'] ?? 'active', 'active' ); ?>><?php esc_html_e( 'Active', 'CTADZ-school-management' ); ?></option>
                            <option value="completed" <?php selected( $form_data['status'] ?? '', 'completed' ); ?>><?php esc_html_e( 'Completed', 'CTADZ-school-management' ); ?></option>
                            <option value="dropped" <?php selected( $form_data['status'] ?? '', 'dropped' ); ?>><?php esc_html_e( 'Dropped', 'CTADZ-school-management' ); ?></option>
                            <option value="suspended" <?php selected( $form_data['status'] ?? '', 'suspended' ); ?>><?php esc_html_e( 'Suspended', 'CTADZ-school-management' ); ?></option>
                        </select>
                    </td>
                </tr>

                <tr>
                    <th scope="row">
                        <label for="payment_status"><?php esc_html_e( 'Payment Status', 'CTADZ-school-management' ); ?> <span style="color: #d63638;">*</span></label>
                    </th>
                    <td>
                        <select id="payment_status" name="payment_status" required>
                            <option value="unpaid" <?php selected( $form_data['payment_status'] ?? 'unpaid', 'unpaid' ); ?>><?php esc_html_e( 'Unpaid', 'CTADZ-school-management' ); ?></option>
                            <option value="partial" <?php selected( $form_data['payment_status'] ?? '', 'partial' ); ?>><?php esc_html_e( 'Partial Payment', 'CTADZ-school-management' ); ?></option>
                            <option value="paid" <?php selected( $form_data['payment_status'] ?? '', 'paid' ); ?>><?php esc_html_e( 'Paid', 'CTADZ-school-management' ); ?></option>
                            <option value="overdue" <?php selected( $form_data['payment_status'] ?? '', 'overdue' ); ?>><?php esc_html_e( 'Overdue', 'CTADZ-school-management' ); ?></option>
                        </select>
                        <p class="description"><?php esc_html_e( 'Current payment status for this enrollment.', 'CTADZ-school-management' ); ?></p>
                    </td>
                </tr>

                <tr>
                    <th scope="row">
                        <label for="enrollment_notes"><?php esc_html_e( 'Notes', 'CTADZ-school-management' ); ?></label>
                    </th>
                    <td>
                        <textarea id="enrollment_notes" name="notes" rows="4" class="large-text"><?php echo esc_textarea( $form_data['notes'] ?? '' ); ?></textarea>
                        <p class="description"><?php esc_html_e( 'Optional notes or comments about this enrollment.', 'CTADZ-school-management' ); ?></p>
                    </td>
                </tr>
            </table>

            <p class="submit">
                <?php submit_button( 
                    $is_edit ? __( 'Update Enrollment', 'CTADZ-school-management' ) : __( 'Create Enrollment', 'CTADZ-school-management' ), 
                    'primary', 
                    'sm_save_enrollment', 
                    false 
                ); ?>
                <a href="?page=school-management-enrollments" class="button" style="margin-left: 10px;"><?php esc_html_e( 'Cancel', 'CTADZ-school-management' ); ?></a>
            </p>
            
            <p class="description">
                <span style="color: #d63638;">*</span> <?php esc_html_e( 'Required fields', 'CTADZ-school-management' ); ?>
            </p>

        <script>
        jQuery(document).ready(function($) {
            <?php if ( ! $is_edit ) : // Only for new enrollments ?>
            
            // Handle course selection change
            $('#enrollment_course').on('change', function() {
                var courseId = $(this).val();
                
                // Hide and reset course payment info
                $('#course_payment_info_row').hide();
                $('#course_payment_info').removeClass('subscription');
                
                if (!courseId) {
                    // Reset payment plan to default options
                    resetPaymentPlanOptions();
                    return;
                }
                
                // Show loading state (don't destroy the dropdown!)
                var $paymentPlan = $('#payment_plan');
                var $paymentPlanTd = $paymentPlan.closest('td');
                
                // Disable dropdown and show loading indicator
                $paymentPlan.prop('disabled', true);
                $paymentPlan.html('<option><?php esc_html_e( 'Loading payment options...', 'CTADZ-school-management' ); ?></option>');
                
                // Remove any existing description
                $paymentPlanTd.find('.description').remove();
                
                // Make AJAX call to get course payment info
                $.ajax({
                    url: smAjax.ajaxurl,
                    type: 'POST',
                    data: {
                        action: 'sm_get_course_payment_info',
                        nonce: smAjax.nonce,
                        course_id: courseId
                    },
                    success: function(response) {
                        if (response.success && response.data) {
                            updateCoursePaymentInfo(response.data);
                            updatePaymentPlanOptions(response.data);
                        } else {
                            alert(response.data.message || smAjax.strings.error);
                            resetPaymentPlanOptions();
                        }
                    },
                    error: function() {
                        alert(smAjax.strings.error);
                        resetPaymentPlanOptions();
                    }
                });
            });
            
            // Function to update course payment info display
            function updateCoursePaymentInfo(data) {
                var $infoBox = $('#course_payment_info');
                var $infoRow = $('#course_payment_info_row');
                
                // Update badge
                $infoBox.find('.sm-payment-model-badge').text(data.payment_model_label);
                
                // Update course name
                $infoBox.find('.sm-course-name').html('<strong>' + data.course_name + '</strong>');
                
                // Update payment details
                var detailsHtml = '';
                if (data.payment_model === 'full_payment') {
                    detailsHtml = '<?php esc_html_e( 'This course requires full payment upfront:', 'CTADZ-school-management' ); ?> <strong>' + data.total_price + '</strong>';
                } else if (data.payment_model === 'monthly_installments') {
                    detailsHtml = data.price_per_month + '<?php esc_html_e( '/month for ', 'CTADZ-school-management' ); ?>' + data.total_months + '<?php esc_html_e( ' months (Total: ', 'CTADZ-school-management' ); ?>' + data.total_price + ')';
                } else if (data.payment_model === 'monthly_subscription') {
                    detailsHtml = '<?php esc_html_e( 'Flexible monthly subscription: ', 'CTADZ-school-management' ); ?><strong>' + data.price_per_month + '<?php esc_html_e( '/month', 'CTADZ-school-management' ); ?></strong><br><em><?php esc_html_e( 'Student can cancel anytime', 'CTADZ-school-management' ); ?></em>';
                    $infoBox.addClass('subscription');
                }
                $infoBox.find('.sm-payment-details').html(detailsHtml);
                
                // Show the info box
                $infoRow.show();
            }
            
            // Function to update payment plan dropdown options
            function updatePaymentPlanOptions(data) {
                var $paymentPlan = $('#payment_plan');
                var $paymentPlanTd = $paymentPlan.closest('td');
                
                // Clear current options
                $paymentPlan.empty();
                
                // Re-enable the dropdown
                $paymentPlan.prop('disabled', false);
                
                // Add options based on available plans
                $.each(data.available_plans, function(index, plan) {
                    var optionText = data.plan_descriptions[plan] || plan;
                    $paymentPlan.append('<option value="' + plan + '">' + optionText + '</option>');
                });
                
                // Remove any existing description
                $paymentPlanTd.find('.description').remove();
                
                // Add description
                var descriptionHtml = '<p class="description">';
                if (data.available_plans.length === 1) {
                    descriptionHtml += '<?php esc_html_e( 'This course only allows this payment method.', 'CTADZ-school-management' ); ?>';
                } else {
                    descriptionHtml += '<?php esc_html_e( 'Choose how the student will pay for the course.', 'CTADZ-school-management' ); ?>';
                }
                descriptionHtml += '</p>';
                
                // Append description after the select element
                $paymentPlan.after(descriptionHtml);
            }
            
            // Function to reset payment plan options to default
            function resetPaymentPlanOptions() {
                var $paymentPlan = $('#payment_plan');
                var $paymentPlanTd = $paymentPlan.closest('td');
                
                // Re-enable dropdown
                $paymentPlan.prop('disabled', false);
                
                // Reset to default options
                $paymentPlan.empty();
                $paymentPlan.append('<option value="monthly"><?php esc_html_e( 'Monthly Payments', 'CTADZ-school-management' ); ?></option>');
                $paymentPlan.append('<option value="quarterly"><?php esc_html_e( 'Quarterly Payments (Every 3 months)', 'CTADZ-school-management' ); ?></option>');
                $paymentPlan.append('<option value="full"><?php esc_html_e( 'Full Payment (One-time)', 'CTADZ-school-management' ); ?></option>');
                
                // Remove existing description
                $paymentPlanTd.find('.description').remove();
                
                // Add default description
                var descriptionHtml = '<p class="description"><?php esc_html_e( 'Choose how the student will pay for the course.', 'CTADZ-school-management' ); ?></p>';
                $paymentPlan.after(descriptionHtml);
            }
            
            <?php endif; ?>
        });
        </script>
        </form>
        <?php
    }
}

// Instantiate class
new SM_Enrollments_Page();